---
// src/pages/blog/category/[slug].astro
// Дублирующий маршрут на случай, если CATEGORY_BASE = "blog/category" в конфиге
import type { GetStaticPaths } from 'astro'
import PageLayout from '~/layouts/PageLayout.astro'
import Headline from '~/components/blog/Headline.astro'
import BlogList from '~/components/blog/List.astro'

import { sanityClient, urlFor } from '~/lib/sanity'
import { categoriesSlugsQuery, categoryBySlugQuery, postsByCategoryQuery } from '~/lib/queries'
import { mapSanityPostsToTheme } from '~/lib/mapSanityToThemePost'

export const getStaticPaths: GetStaticPaths = async () => {
  const slugs: { slug: string }[] = await sanityClient.fetch(categoriesSlugsQuery)
  return slugs.map((c) => ({ params: { slug: c.slug } }))
}

const { slug } = Astro.params

const category = await sanityClient.fetch(categoryBySlugQuery, { slug })
if (!category) throw new Error('Category not found: ' + slug)

const sanityPosts = await sanityClient.fetch(postsByCategoryQuery, { slug, limit: 60 })
const posts = mapSanityPostsToTheme(sanityPosts, urlFor)
---

<PageLayout
  metadata={{
    title: `Категория: ${category.title}`,
    description: `Посты в категории “${category.title}”`,
    openGraph: { type: 'blog' },
  }}
>
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
    <Headline subtitle={`Посты в категории “${category.title}”`}>Категория: {category.title}</Headline>
    <BlogList posts={posts} />
  </section>
</PageLayout>
